#!/bin/bash

filename="ply/modelnet10/dresser/train/dresser_0001.ply"

CODING_SCALES=(
  4294967296.00000000000000000000000000000000
  2147483648.00000000000000000000000000000000
  1073741824.00000000000000000000000000000000
   536870912.00000000000000000000000000000000
   268435456.00000000000000000000000000000000
   134217728.00000000000000000000000000000000
    67108864.00000000000000000000000000000000
    33554432.00000000000000000000000000000000
    16777216.00000000000000000000000000000000
     8388608.00000000000000000000000000000000
     4194304.00000000000000000000000000000000
     2097152.00000000000000000000000000000000
     1048576.00000000000000000000000000000000
      524288.00000000000000000000000000000000
      262144.00000000000000000000000000000000
      131072.00000000000000000000000000000000
       65536.00000000000000000000000000000000
       32768.00000000000000000000000000000000
       16384.00000000000000000000000000000000
        8192.00000000000000000000000000000000
        4096.00000000000000000000000000000000
        2048.00000000000000000000000000000000
        1024.00000000000000000000000000000000
         512.00000000000000000000000000000000
         256.00000000000000000000000000000000
         128.00000000000000000000000000000000
          64.00000000000000000000000000000000
          32.00000000000000000000000000000000
          16.00000000000000000000000000000000
           8.00000000000000000000000000000000
           4.00000000000000000000000000000000
           2.00000000000000000000000000000000
           1.00000000000000000000000000000000
           0.50000000000000000000000000000000
           0.25000000000000000000000000000000
           0.12500000000000000000000000000000
           0.06250000000000000000000000000000
           0.03125000000000000000000000000000
           0.01562500000000000000000000000000
           0.00781250000000000000000000000000
           0.00390625000000000000000000000000
           0.00195312500000000000000000000000
           0.00097656250000000000000000000000
           0.00048828125000000000000000000000
           0.00024414062500000000000000000000
           0.00012207031250000000000000000000
           0.00006103515625000000000000000000
           0.00003051757812500000000000000000
           0.00001525878906250000000000000000
           0.00000762939453125000000000000000
           0.00000381469726562500000000000000
           0.00000190734863281250000000000000
           0.00000095367431640625000000000000
           0.00000047683715820312500000000000
           0.00000023841857910156250000000000
           0.00000011920928955078125000000000
           0.00000005960464477539062500000000
           0.00000002980232238769531250000000
           0.00000001490116119384765625000000
           0.00000000745058059692382812500000
           0.00000000372529029846191406250000
           0.00000000186264514923095703125000
           0.00000000093132257461547851562500
           0.00000000046566128730773925781250
           0.00000000023283064365386962890625
)

# CODING_SCALES=(
#   1
#   0.75
#   0.5
#   0.375
#   0.25
#   0.1875
#   0.125
#   0.09375
#   0.0625
#   0.046875
#   0.03125
#   0.0234375
#   0.015625
#   0.01171875
#   0.0078125
#   0.005859375
#   0.00390625
#   0.0029296875
#   0.001953125
#   0.00146484375
#   0.0009765625
#   0.000732421875
#   0.00048828125
#   0.0003662109375
#   0.000244140625
#   0.00018310546875
#   0.0001220703125
# )

outdir="tmp"
mkdir -p "$outdir"
cp "$filename" "$outdir/tmp.ply"

# TODO check using PCGC python params, but otherwise use default
# TODO generate CSV of num points, filesize, name, coding scale, etc
# TODO group by compressed filesize or perhaps target number of points into separate datasets...?
# TODO train on each dataset...? with enough points...   (or just run evaluate...; don't need to train on the distorted points...)

# How to deal with different # of points and bpps??
# Just do # of points... and then take bpp.

# I wonder if GPCC can have subsample of points... maybe we do that ourselves

# e.g. pre-subsample N=... points. Make dataset for each N. Train PointNets for each N. Then, run GPCC.


for cs in "${CODING_SCALES[@]}"; do
  echo ">>> $cs"
  tmc3 --mode=0 --compressedStreamPath="$outdir/tmp.bin" --uncompressedDataPath="$outdir/tmp.ply" --inputScale="$cs" # --codingScale="$cs"
  tmc3 --mode=1 --compressedStreamPath="$outdir/tmp.bin" --reconstructedDataPath="$outdir/tmp.rec.ply" --outputBinaryPly=0
  mv "$outdir/tmp.rec.ply" "$outdir/${cs}.rec.ply"
  echo "<<< $cs"
done
